#!/bin/bash

# Safety checks
if [ "$EUID" -eq 0 ]; then
    echo "Error: Do not run this script as root or with sudo"
    exit 1
fi

SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
VENV_DIR="$SCRIPT_DIR/.venv"
PYTHON_SCRIPT="$SCRIPT_DIR/src/static_site_image_optimizer/cli.py"

if [ ! -d "$VENV_DIR" ]; then
    echo "Setting up virtual environment..."
    
    if command -v pixi &> /dev/null; then
        cd "$SCRIPT_DIR"
        pixi init
        pixi add pillow
        pixi shell
    elif command -v uv &> /dev/null; then
        cd "$SCRIPT_DIR"
        uv venv "$VENV_DIR"
        source "$VENV_DIR/bin/activate"
        uv pip install -r "$SCRIPT_DIR/requirements.txt"
    elif command -v python3 &> /dev/null; then
        cd "$SCRIPT_DIR"
        python3 -m venv "$VENV_DIR"
        source "$VENV_DIR/bin/activate"
        pip install -r "$SCRIPT_DIR/requirements.txt"
    else
        echo "Error: Neither pixi, uv, nor python3 found. Please install one."
        exit 1
    fi
    
    echo "Setup complete!"
fi

source "$VENV_DIR/bin/activate"
export PYTHONPATH="$SCRIPT_DIR/src:$PYTHONPATH"
python -m static_site_image_optimizer.cli "$@"
